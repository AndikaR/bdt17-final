<%- include('modules/head') -%>
<body class="stretched" id="canvas-container">
	<!--link href='http://fonts.googleapis.com/css?family=Open+Sans:400,700' rel='stylesheet' type='text/css'>
	<link type="text/css" rel="stylesheet" href="assets/css/styles.css" />
	<link rel="stylesheet" type="text/css" href="http://code.jquery.com/ui/1.9.2/themes/base/jquery-ui.css"/>
	<link rel="stylesheet" href="http://code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css" />
	<link rel="stylesheet" href="assets/css/bootstrap.css">
	<link rel="stylesheet" href="assets/revealjs/css/reveal.css" />
	<link rel="stylesheet" href="assets/revealjs/css/theme/black.css" id="theme" />
	<link rel="stylesheet" href="assets/css/fontawesome.css" -->

	<link rel="stylesheet" type="text/css" href="http://code.jquery.com/ui/1.9.2/themes/base/jquery-ui.css"/>
	<link rel="stylesheet" href="http://code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css" />
	<link rel="stylesheet" href="assets/revealjs/css/reveal.css" />
	<link rel="stylesheet" href="assets/revealjs/css/theme/black.css" id="theme" />
	
	<style>
		/*
		* { margin: 0; padding: 0; box-sizing: border-box; }
		body { font: 13px Helvetica, Arial; }
		
		form { background:rgba(0,0,0,0.0); padding: 0px; position: fixed; bottom: 0; width: 100%; }
		*/
		.ctrl-panel {
			padding: 5px;
			position: fixed;
			bottom: 50px;
			left: 90;
			right: 0;
			padding-bottom: 10px; 
			width: 100%;  
			z-index: 9;
		}
		#messages { 
			background:rgba(0,0,0,0.5); 
			padding: 5px; 
			margin-bottom: 35px; 
			position: fixed; 
			bottom: 0; 
			width: 100%; 
			max-height: 300px; 
			overflow: auto;
			resize: vertical;
			z-index: 9;
		}
		div.form-group { margin-bottom: 0px; }
		#messages li { padding: 2px 10px; }
		.darkorange { color:darkorange }
		.white { color: white }
		svg { 
			width : 100%; 
			height: -webkit-calc(100% - 35px);
			height:    -moz-calc(100% - 35px);
			height:         calc(100% - 35px);
		}
		.no-slide { background-image: url('http://via.placeholder.com/1280x800'); width: 100%; height: 100%; }
		.pr-45 { padding-right: 45px !important; }
		.pl-45 { padding-left: 45px !important; }
		.pt-5 { padding-top: 5px !important; }
		.pt-10 { padding-top: 10px !important; }

		.chat-bar {
			z-index: 299;
			position: fixed;
			width: 100%;
			height: 60px;
			background-color: #1ABC9C;
			font-size: 20px;
			line-height: 36px;
			top: auto;
			bottom: -5px;
		}

		.chat-square-button {
			width: 50px;
			height: 50px;
		}
	</style>
	<!-- Document Wrapper
	============================================= -->
	<div id="wrapper" class="clearfix">

    <%- include('modules/header-lobby') -%>

		<!-- Content
		============================================= -->
		<section id="content">
      <div class="container clearfix canvas-container">
				<div class="reveal">
					<div class="slides"></div>
				</div>
      </div>
		</section><!-- #content end -->
	</div><!-- #wrapper end -->
	<div class="chat-list">
		<ul class="resize vertical" id="messages"></ul>
	</div>
	<div class="ctrl-panel" style="display: none;"></div>
	<input type="hidden" id="user" value="<%= user %>">
	<input type="hidden" id="host" value="<%= host %>">
	<input type="hidden" name="room_number" value="<%= room_id %>">
	<div class="chat-bar">
		<!-- Primary Navigation
		============================================= -->
		<nav id="primary-menu" class="style-5 pull-left">
			<ul class="norightborder norightpadding norightmargin chat-ul">
				<li>
					<a href="#" class="feature-box fbox-rounded fbox-effect pr-45" id="toggle_chat">
						<div class="fbox-icon pt-5">
							<i class="icon-comments-alt pt-10"></i>
						</div>
					</a>
				</li>
				<li>
					<a class="feature-box fbox-rounded fbox-effect pr-45" id="toggle_none">
						<div class="fbox-icon pt-5">
							<i class="icon-file-alt pt-10"></i>
						</div>
					</a>
				</li>
			</ul>
		</nav><!-- #primary-menu end -->
		<input type="text" id="m" style="height: 50px; font-size: 30px; padding-top: 3px; flex: 1;" placeholder="Type &amp; Hit Enter..">
		<button class="button button-3d button-xlarge button-rounded button-teal pull-right" style="margin-top: 2px;" id="sm">Send</button>
	</div>

	<!-- Go To Top
	============================================= -->
	<div id="gotoTop" class="icon-angle-up"></div>

  <%- include('modules/script') -%>

	<!-- Bootstrap library -->
	<script src="assets/js/bootstrap.js"></script>

	<!-- jQuery UI -->
	<script src="//code.jquery.com/ui/1.9.2/jquery-ui.js"></script>

	<!-- Reveal.js is for presentations -->
	<script src="assets/revealjs/lib/js/head.min.js"></script>
	<script src="assets/revealjs/js/reveal.js"></script>

	<!-- Raphael library -->
	<script src="//cdnjs.cloudflare.com/ajax/libs/raphael/2.2.7/raphael.js"></script>

	<!-- Main JavaScript file -->
	<script src="assets/js/script.js"></script>

  <script>
    $(function() {
			// Initialize the Reveal.js library with the default config options
			// See more here https://github.com/hakimel/reveal.js#configuration
			function initReveal() {
				Reveal.initialize({ 
					history: true, 
					mouseWheel: false,
					controls: false,
					touch: false,
					keyboard: false,
					embedded: false,
					progress: false,
					autoSlide: 0
				});
			}

			var init_reveal = false;
			var room = $('input[name=room_number]').val();
			var user = $('#user').val();

			//Admin state
			var mouse_state = false;

			var prevMouseX, prevMouseY, currMouseX, currMouseY     = 0;
      var prevScreenX, prevScreenY, currScreenX, currScreenY = 0; 
			//End of Admin state

			var socket = io.connect($('#host').val() + '/lobby');

			// Admin and User
			socket.emit('join_room', { room: room, id: user.id });

			socket.on('access_granted', function(panel){
				$('.ctrl-panel').append(panel).show();
				admin();
			});

			socket.on('revoke_admin', function(action){
				
			});

			socket.on('admin_response', function(eventName){ 
				Reveal[eventName](); 
				socket.emit('change_current', { hash: location.hash }); 
			});

			socket.on('update_slide', function(slides){ 
				var $slides = $('.slides');

				$slides.empty();

				if (slides.list.length) {
					for (var i = 0; i < slides.list.length; i++) {
						$slides.append('<section data-background="/slide/' + slides.list[i] + '"></section>');
					}
				} else {
					$slides.append('<section data-background="http://via.placeholder.com/1280x800"></section>');
				}

				socket.emit('illegal_hash');
				initReveal();
			});

			$('ul.chat-ul li a#toggle_chat').click(function(e) {
        e.preventDefault();
				$('.chat-list').toggle();
    	});

			$('ul.chat-ul li a#toggle_none').click(function(e) {
        e.preventDefault();
    	});

			function emitMessage() {
				socket.emit('chat_message', { 
					message: $('#m').val(),
					room: room
				});
				$('#m').val('');
			}

			var key_map = {};
			onkeydown = onkeyup = function(e){
				e = e || event; // to deal with IE
				key_map[e.keyCode] = e.type == 'keydown';
				var isMsgFocus = (key_map[13] && $('#m').is(':focus')); //Enter key

				if (key_map[16] && isMsgFocus) {
					$('#m').val($('#m').val() + '\n');
				} else if (isMsgFocus) {
					emitMessage();
				}
			}

			$('#sm').click(function(){
				emitMessage();
			});

			socket.on('chat_message', function(msg){
				$('#messages').append($('<li>').html('<p class="white">' + msg + '</p>'));
			});

			var user = function() {
				var paper = new Raphael(
					$('#canvas-container'), 
					window.width, 
					window.height
				);
				
				var circle = paper.circle(0, 0, 10).attr({ fill: '#fff' });

				circle.hide();

				socket.on('mouse_toggle_update', function(data){
					if (data) circle.show();
					else circle.hide();
				});

				socket.on('mouse_position_update', function(data){
					circle.animate({
						cx: data.mx * $(window).width(),
						cy: data.my * $(window).height()
					}, 1, 'linear');
				});

				socket.on('online_counter', function(val){
					$('#online').text(val);
				});

				socket.on('force_hash', function(currentHash){
					window.location.hash = currentHash;
				});

				$(window).on('hashchange', function(){
					socket.emit('illegal_hash');
				});
			};

			var admin = function() {
				window.setInterval(function(){
          if (mouse_state) {
            $("body").mousemove(function(e) {
              currMouseX = e.pageX;
              currMouseY = e.pageY;
              currScreenX = e.screenX;
              currScreenY = e.screenY;
            });

            if (prevMouseX !== currMouseX || prevMouseY !== currMouseY) {
              var newX = (prevMouseX * currScreenX) / prevScreenX;
		          var newY = (prevMouseY * currScreenY) / prevScreenY;

              prevMouseX = currMouseX;
              prevMouseY = currMouseY;

              prevScreenX = currScreenX;
              prevScreenY = currScreenY;

              socket.emit('mouse_position', { 
                mx: (newX / $(window).width()), 
                my: (newY / $(window).height())
              });
            }
          }
        }, 100);

        function toggle_mouse() {
          $icon = $('.mouse-toggle').find('.mouse');

          if (!mouse_state) $icon.css('color', 'green');
          else $icon.css('color', 'red');

          mouse_state = !mouse_state;
          socket.emit('admin_request', { eventName: 'mouse_toggle', content: mouse_state });
        };

        $(document).keydown(function(event){
          if (event.which == "17") toggle_mouse(); //ctrl key
        });

        $('.mouse-toggle').on('click', function(){
          toggle_mouse();
        });

				$('.ctrl-panel').on('click', '#upload-file', function(){
					$('#pdf-file').trigger('click');
				});

				$('.ctrl-panel').on('click', '#pdf-upload', function(){
					var formData = new FormData($('form#pdf-upload-form').get(0));
					
					$.ajax({
						url: '/admin/file-upload/' + room,
						data: formData,
						processData: false,
						contentType: false,
						type: 'POST',
						success : function(data) {
							console.log(data);
						}
						,error:function(a, b, c) {
							console.log(a);
							console.log(b);
							console.log(c);
						}
					}).done(function(data) {
						//On done
					});
				});

				$('.ctrl-panel').on('change', '#pdf-file', function(){
					var fname = ($(this).val() != '') ? $(this).val().split('\\').pop().split('/').pop() : null;

					$('#pdf-name').val(fname);
				});

				$('.ctrl-panel').on('click', '.navigate', function() {
					var id = $(this).attr('id') // or this.id
					
					socket.emit('admin_request', { eventName: id });
				});

				$('.ctrl-panel').on('click', '.toggle-panel', function() {
					$('.sub-ctrl-panel').toggle();

					//$(this).show(); // or this.id
				});
			}
		});
  </script>
</body>
</html>